<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17826751022"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'AW-17826751022');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel | RedaXion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .progress-container {
            max-width: 600px;
            margin: 0 auto 3rem auto;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 5px;
            position: relative;
        }

        .progress-bar {
            height: 20px;
            background: var(--accent-cyan);
            border-radius: 50px;
            width: 0%;
            transition: width 1s ease-in-out;
            box-shadow: 0 0 10px rgba(28, 198, 194, 0.5);
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(45deg,
                    rgba(255, 255, 255, 0.15) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.15) 75%,
                    transparent 75%,
                    transparent);
            background-size: 1rem 1rem;
            animation: progress-stripe 1s linear infinite;
        }

        @keyframes progress-stripe {
            0% {
                background-position: 1rem 0;
            }

            100% {
                background-position: 0 0;
            }
        }

        /* Stop animation when completed */
        .progress-bar.completed::after {
            animation: none;
            background: none;
        }

        .progress-bar.completed {
            background: linear-gradient(90deg, #00d26a, #00f260) !important;
        }

        .progress-text {
            text-align: center;
            margin-top: 1rem;
            font-weight: 600;
            color: var(--text-gray);
            min-height: 1.5em;
        }

        .file-viewer {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            height: 600px;
        }

        .file-list {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .file-item {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .file-item:hover,
        .file-item.active {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-item.active {
            border-left: 3px solid var(--accent-cyan);
        }

        .preview-area {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--glass-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }
    </style>
    <link rel="icon" type="image/png" href="/static/img/favicon3.png">
</head>

<body>
    {% include 'header.html' %}

    <main class="section-padding" style="padding-top: 8rem;">
        <div class="container">
            <div class="dashboard-header">
                <h1>Tu <span class="text-gradient">Pedido</span></h1>
                <p>Orden ID: <span id="orden-id-display"
                        style="font-family: monospace; color: var(--accent-cyan);">Cargando...</span></p>
            </div>

            <!-- Status Tracker (Progress Bar) -->
            <div class="progress-wrap">
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">Cargando estado...</div>
            </div>


            <!-- Main Content Area -->
            <!-- Dynamic Content Area -->
            <div id="status-content" style="text-align: center; margin: 4rem 0;">

                <!-- 1. PENDING STATE -->
                <div id="pending-state" class="hidden">
                    <h2 style="margin-bottom: 1rem;">¬°Orden Creada! üöÄ</h2>
                    <p class="text-gray-400">Para comenzar a trabajar, necesitamos confirmar tu pago.</p>

                    <div
                        style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; align-items: center;">
                        <a id="btn-pay-mp" href="#" target="_blank" class="btn btn-primary"
                            style="background: #009EE3; border: none; padding: 1rem 2rem; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                            <span>üí≥</span> Pagar con Mercado Pago
                        </a>
                    </div>
                </div>

                <!-- 2. PROCESSING STATE -->
                <div id="processing-state" class="hidden">
                    <h2 style="margin-bottom: 1rem;">Estamos trabajando en tu documento ü§ñ</h2>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">La generaci√≥n puede tardar entre <strong>2-5
                            minutos</strong> dependiendo de la complejidad.</p>
                    <p style="color: var(--text-gray); font-size: 0.9rem;">No cierres esta p√°gina. Te notificaremos
                        cuando est√© listo.</p>
                    <!-- Time estimator removed as requested -->
                    <div style="margin-top: 2rem; font-size: 2rem;" class="animate-spin">‚è≥</div>
                </div>

            </div>

            <div id="results-area" class="file-viewer hidden">
                <div class="file-list">
                    <h3 style="margin-bottom: 1.5rem;">Tus Archivos</h3>
                    <div id="files-container">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="preview-area">
                    <div id="preview-placeholder" class="loading-overlay" style="background: #f0f0f0; color: #333;">
                        <p>Selecciona un archivo para previsualizar</p>
                    </div>
                    <iframe id="file-frame" class="hidden"></iframe>
                </div>
            </div>

            <!-- Feedback Section (Visible when completed) -->
            <div id="feedback-section" class="hidden"
                style="margin-top: 4rem; padding-top: 3rem; border-top: 1px solid var(--glass-border); text-align: center;">
                <h3 style="margin-bottom: 1rem;">¬øQu√© te pareci√≥ el resultado? üí¨</h3>
                <p style="color: var(--text-gray); margin-bottom: 2rem;">Tus comentarios nos ayudan a mejorar el
                    servicio.</p>

                <form id="orderCommentForm" style="max-width: 600px; margin: 0 auto; text-align: left;">
                    <input type="hidden" name="page" value="order">
                    <input type="hidden" name="order_id" id="comment-order-id">
                    <textarea name="comment" required
                        placeholder="D√©janos tus comentarios, sugerencias o si encontraste alg√∫n detalle..."
                        style="width: 100%; height: 100px; padding: 0.8rem; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: white; resize: vertical; margin-bottom: 1rem;"></textarea>
                    <button type="submit" class="btn btn-outline"
                        style="width: 100%; border-color: var(--accent-cyan); color: var(--accent-cyan);">Enviar
                        Feedback</button>
                </form>
                <div id="orderCommentStatus"
                    style="margin-top: 1rem; display: none; padding: 1rem; border-radius: 8px;"></div>
            </div>
        </div>
    </main>

    <script src="/static/js/main.js"></script>
    <script>
        // Get Orden ID from URL params (e.g. ?external_reference=...)
        const params = new URLSearchParams(window.location.search);
        // MercadoPago sends 'external_reference' or we might rely on 'preference_id'
        const ordenId = params.get('external_reference') || params.get('orden_id') || localStorage.getItem('last_orden_id');

        document.getElementById('orden-id-display').textContent = ordenId || 'Desconocido';

        let progressInterval = null;
        let currentProgress = 0;

        // Time estimation function removed

        function updateProgress(status) {
            const bar = document.getElementById('progress-bar');
            const text = document.getElementById('progress-text');

            // Hide all states first
            document.getElementById('pending-state').classList.add('hidden');
            document.getElementById('processing-state').classList.add('hidden');
            document.getElementById('results-area').classList.add('hidden');

            if (status === 'pending') {
                // Clear any running animation
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                currentProgress = 25;
                bar.style.transition = 'width 0.5s ease-out';
                bar.style.width = '25%';
                text.textContent = 'Orden Recibida - Esperando Pago';

                document.getElementById('pending-state').classList.remove('hidden');
                // Set Checkout URL if available in params
                const params = new URLSearchParams(window.location.search);
                const checkoutUrl = params.get('checkout_url');
                if (checkoutUrl) {
                    document.getElementById('btn-pay-mp').href = decodeURIComponent(checkoutUrl);
                } else {
                    document.getElementById('btn-pay-mp').style.display = 'none';
                }
            }

            if (status === 'paid' || status === 'processing') {
                document.getElementById('processing-state').classList.remove('hidden');

                // Start gradual progress animation
                if (!progressInterval) {
                    // Start from current position or 30%
                    if (currentProgress < 30) currentProgress = 30;

                    const statusTexts = [
                        'Pago Confirmado - Iniciando...',
                        'Transcribiendo audio con IA...',
                        'Procesando texto con ChatGPT...',
                        'Aplicando formato al documento...',
                        'Generando cuestionario...',
                        'Finalizando archivos...'
                    ];
                    let textIndex = status === 'paid' ? 0 : 1;
                    text.textContent = statusTexts[textIndex];

                    bar.style.transition = 'width 0.3s ease-out';
                    bar.style.width = currentProgress + '%';

                    progressInterval = setInterval(() => {
                        // Slowly increase up to 90% max while processing
                        if (currentProgress < 90) {
                            currentProgress += Math.random() * 2 + 0.5; // Random increment 0.5-2.5%
                            if (currentProgress > 90) currentProgress = 90;
                            bar.style.width = currentProgress + '%';

                            // Update text at certain thresholds
                            if (currentProgress > 40 && textIndex < 1) {
                                textIndex = 1;
                                text.textContent = statusTexts[textIndex];
                            } else if (currentProgress > 55 && textIndex < 2) {
                                textIndex = 2;
                                text.textContent = statusTexts[textIndex];
                            } else if (currentProgress > 70 && textIndex < 3) {
                                textIndex = 3;
                                text.textContent = statusTexts[textIndex];
                            } else if (currentProgress > 80 && textIndex < 4) {
                                textIndex = 4;
                                text.textContent = statusTexts[textIndex];
                            } else if (currentProgress > 88 && textIndex < 5) {
                                textIndex = 5;
                                text.textContent = statusTexts[textIndex];
                            }
                        }
                    }, 800); // Update every 800ms
                }
            }

            if (status === 'completed') {
                // Clear animation
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                currentProgress = 100;
                bar.style.transition = 'width 0.5s ease-out';
                bar.style.width = '100%';
                text.textContent = '¬°Listo! Descarga tus archivos.';
                document.getElementById('results-area').classList.remove('hidden');
                document.getElementById('feedback-section').classList.remove('hidden');
                document.getElementById('comment-order-id').value = ordenId;
            }
        }

        let completionNotified = false;

        async function pollStatus() {
            if (!ordenId) return;

            try {
                const response = await fetch(`/api/status/${ordenId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        // Order not found - show error message
                        const text = document.getElementById('progress-text');
                        const bar = document.getElementById('progress-bar');
                        text.innerHTML = '‚ùå <strong>Orden no encontrada.</strong> Verifica el ID e intenta de nuevo.';
                        text.style.color = '#e74c3c';
                        bar.style.width = '0%';
                        bar.style.background = '#e74c3c';

                        // Hide all states and show error
                        document.getElementById('pending-state').classList.add('hidden');
                        document.getElementById('processing-state').classList.add('hidden');
                        document.getElementById('results-area').classList.add('hidden');
                        return; // Stop polling
                    }
                    // Other server errors - continue polling
                    console.log("Status API returned error, retrying...");
                    setTimeout(pollStatus, 3000);
                    return;
                }

                const data = await response.json();
                console.log("Status update:", data);

                // Time estimation removed

                updateProgress(data.status);

                if (data.status === 'completed') {
                    // Render files IMMEDIATELY if available (fixes race condition)
                    if (data.files && data.files.length > 0) {
                        renderFiles(data.files);
                    }

                    // Only notify once
                    if (!completionNotified) {
                        completionNotified = true;

                        // Stop the progress bar animation
                        const bar = document.getElementById('progress-bar');
                        bar.classList.add('completed');

                        // Show confetti celebration
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });

                        // Play notification sound (optional)
                        try {
                            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fZJJkgXZkXnJ3e26GgX1ze3h7b3J8eHN6');
                            audio.play().catch(() => { });
                        } catch (e) { }

                        console.log("‚úÖ Proceso completado!");
                    }
                    // Stop polling after completion
                    return;
                } else {
                    setTimeout(pollStatus, 3000); // Poll every 3s
                }
            } catch (e) {
                console.error("Polling error", e);
                setTimeout(pollStatus, 5000); // Retry on error
            }
        }

        function renderFiles(files) {
            const container = document.getElementById('files-container');
            container.innerHTML = '';

            // Filter: Only show PDF files
            const filesToShow = files.filter(f => f.type === 'pdf');

            if (filesToShow.length === 0) {
                container.innerHTML = '<div style="color: white; opacity: 0.7;">No hay previsualizaciones disponibles. Revisa tu correo.</div>';
                return;
            }

            filesToShow.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                if (index === 0) item.classList.add('active'); // Select first default

                let icon = 'üìï'; // PDF Icon

                item.innerHTML = `
                    <div style="font-size: 1.5rem;">${icon}</div>
                    <div>
                        <div style="font-weight: 600;">${file.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-gray);">${file.type.toUpperCase()}</div>
                    </div>
                `;

                item.onclick = () => {
                    document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    loadPreview(file.url, file.type);
                };

                container.appendChild(item);

                // Auto load first
                if (index === 0) loadPreview(file.url, file.type);
            });
        }

        function loadPreview(url, type) {
            const frame = document.getElementById('file-frame');
            const placeholder = document.getElementById('preview-placeholder');

            placeholder.classList.add('hidden');
            frame.classList.remove('hidden');


            if (type === 'pdf') {
                frame.src = url + "?t=" + new Date().getTime();
            } else {
                // For DOCX, we might not be able to preview simply in iframe unless we rely on GViewer
                // For now, use GViewer fallback or just download
                frame.src = `https://docs.google.com/gview?url=${window.location.origin}${url}&embedded=true`;

                // Show message if GView might fail (localhost)
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isLocal) {
                    placeholder.innerHTML = `<p>‚ö†Ô∏è En modo Local (localhost), Google Docs no puede previsualizar tus archivos DOCX.<br>Desc√°rgalos para verlos.</p>`;
                    placeholder.classList.remove('hidden');
                    frame.classList.add('hidden');
                }
            }
        }

        function simulatePayment() {
            if (!ordenId) return;
            // Reload with special params to trigger backend processing
            window.location.href = `/dashboard?external_reference=${ordenId}&collection_status=approved`;
        }

        // Feedback Form Logic
        document.getElementById('orderCommentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const status = document.getElementById('orderCommentStatus');

            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                const formData = new FormData(e.target);
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    status.style.display = 'block';
                    status.style.background = 'rgba(46, 204, 113, 0.2)';
                    status.style.color = '#2ecc71';
                    status.textContent = '¬°Gracias por tu feedback! Nos ayuda mucho a mejorar.';
                    e.target.reset();
                    // Keep the button disabled to prevent duplicate submissions
                    btn.textContent = '‚úì Enviado';
                } else {
                    throw new Error('Error al enviar');
                }
            } catch (err) {
                status.style.display = 'block';
                status.style.background = 'rgba(231, 76, 60, 0.2)';
                status.style.color = '#e74c3c';
                status.textContent = 'Hubo un error al enviar el feedback. Intenta de nuevo.';
                btn.disabled = false;
                btn.textContent = 'Enviar Feedback';
            }
        });

        // Start
        if (ordenId) {
            pollStatus();
        } else {
            document.getElementById('loading-state').innerHTML = "<h3>No se encontr√≥ el pedido</h3><p>Verifica el enlace o contacta soporte.</p>";
        }
    </script>
</body>

</html>