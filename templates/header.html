<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17826751022"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'AW-17826751022');
</script>

<header>
    <div class="container">
        <nav>
            <div class="logo">
                <a href="/"><img src="/static/img/logo.png" alt="RedaXion Logo"
                        style="height: 60px; vertical-align: middle;"></a>
            </div>

            <!-- Mobile menu button -->
            <div class="mobile-menu-btn" id="mobileMenuBtn" style="display: none;">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <div class="nav-links" id="navLinks">
                <a href="/">Inicio</a>
                <a href="/como-funciona">C√≥mo Funciona</a>
                <a href="/testimonios">Testimonios</a>
                <div class="dropdown" id="servicesDropdown">
                    <a href="#" class="dropdown-toggle" id="servicesToggle">Servicios Especiales ‚ñæ</a>
                    <div class="dropdown-menu">
                        <a href="/generador-pruebas">üìù Generador de Pruebas</a>
                        <a href="/transcribe-reunion">üéôÔ∏è Transcribe Tu Reuni√≥n</a>
                        <a href="/soluciones-ia">ü§ñ Soluciones IA</a>
                    </div>
                </div>

                <!-- Auth-dependent links -->
                <a href="/mis-ordenes" id="navMisOrdenes">Mis √ìrdenes</a>
                <a href="/mi-cuenta" id="navMiCuenta" style="display: none;">Mi Cuenta</a>

                <a href="/ayuda">Ayuda</a>

                <!-- Auth buttons -->
                <a href="/login" id="navLogin" class="nav-auth-link">Iniciar Sesi√≥n</a>
                <a href="#" id="navLogout" class="nav-auth-link" style="display: none;"
                    onclick="headerLogout(event)">Cerrar Sesi√≥n</a>

                <a href="/orden" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Haz Tus
                    Pedidos</a>
            </div>
        </nav>
    </div>
</header>

<style>
    .nav-auth-link {
        color: var(--accent-cyan) !important;
        font-weight: 500;
    }

    .nav-auth-link:hover {
        text-decoration: underline;
    }
</style>

<script>
    // Mobile menu toggle
    (function () {
        const mobileBtn = document.getElementById('mobileMenuBtn');
        const navLinks = document.getElementById('navLinks');
        const servicesDropdown = document.getElementById('servicesDropdown');
        const servicesToggle = document.getElementById('servicesToggle');

        // Show/hide mobile button based on screen size
        function checkMobile() {
            if (window.innerWidth <= 768) {
                mobileBtn.style.display = 'flex';
            } else {
                mobileBtn.style.display = 'none';
                navLinks.classList.remove('active');
                mobileBtn.classList.remove('active');
            }
        }

        checkMobile();
        window.addEventListener('resize', checkMobile);

        // Toggle mobile menu
        mobileBtn.addEventListener('click', function () {
            navLinks.classList.toggle('active');
            mobileBtn.classList.toggle('active');
        });

        // Toggle services dropdown on mobile
        if (servicesToggle) {
            servicesToggle.addEventListener('click', function (e) {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    servicesDropdown.classList.toggle('active');
                }
            });
        }

        // Close menu when clicking a link
        navLinks.querySelectorAll('a:not(.dropdown-toggle)').forEach(link => {
            link.addEventListener('click', function () {
                if (window.innerWidth <= 768) {
                    navLinks.classList.remove('active');
                    mobileBtn.classList.remove('active');
                }
            });
        });
    })();

    // Check authentication status and update nav
    (async function checkHeaderAuth() {
        try {
            const response = await fetch('/api/auth/me');
            if (response.ok) {
                // User is logged in
                const user = await response.json();

                // Show "Mi Cuenta", hide "Mis √ìrdenes", show logout
                document.getElementById('navMiCuenta').style.display = 'inline';
                document.getElementById('navMisOrdenes').style.display = 'none';
                document.getElementById('navLogin').style.display = 'none';
                document.getElementById('navLogout').style.display = 'inline';

                // Update Mi Cuenta text to show user name
                document.getElementById('navMiCuenta').textContent = `üë§ ${user.name.split(' ')[0]}`;
            } else {
                // Not logged in - default state is fine
            }
        } catch (e) {
            // Error checking auth, keep default state
        }
    })();

    // Logout function
    async function headerLogout(e) {
        e.preventDefault();
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        } catch (error) {
            window.location.href = '/';
        }
    }
</script>